FROM coredns/coredns:1.11.1 AS coredns-binary

# Create a new image with Alpine base for tools
FROM alpine:3.19

# Install essential DNS and network tools
RUN apk add --no-cache \
    bind-tools \
    netcat-openbsd \
    curl \
    ca-certificates \
    tzdata

# Copy CoreDNS binary from official image
COPY --from=coredns-binary /coredns /coredns

# Create coredns user and group
RUN addgroup -g 1001 coredns && \
    adduser -D -u 1001 -G coredns coredns

# Create directories with proper permissions
RUN mkdir -p /etc/coredns /etc/coredns/zones && \
    chown -R coredns:coredns /etc/coredns

# Switch to non-root user
USER coredns

EXPOSE 53 53/udp

ENTRYPOINT ["/coredns"]
