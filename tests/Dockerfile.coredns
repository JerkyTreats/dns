FROM coredns/coredns:1.11.1 AS coredns-binary

# Create a new image with Alpine base for tools
FROM alpine:3.19

# Install essential DNS and network tools
RUN apk add --no-cache \
    bind-tools \
    netcat-openbsd \
    curl \
    ca-certificates \
    tzdata

# Copy CoreDNS binary from official image
COPY --from=coredns-binary /coredns /coredns

# Create coredns user and group
RUN addgroup -g 1001 coredns && \
    adduser -D -u 1001 -G coredns coredns

# Create directories with proper permissions
RUN mkdir -p /etc/coredns /etc/coredns/zones && \
    chown -R coredns:coredns /etc/coredns

# Create entrypoint script
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Copy template to working Corefile if template exists' >> /entrypoint.sh && \
    echo 'if [ -f "/etc/coredns/Corefile.template" ]; then' >> /entrypoint.sh && \
    echo '    echo "Copying Corefile.template to Corefile..."' >> /entrypoint.sh && \
    echo '    cp /etc/coredns/Corefile.template /etc/coredns/Corefile' >> /entrypoint.sh && \
    echo '    echo "Template copied successfully"' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Start CoreDNS with provided arguments' >> /entrypoint.sh && \
    echo 'exec /coredns "$@"' >> /entrypoint.sh

RUN chmod +x /entrypoint.sh && \
    chown coredns:coredns /entrypoint.sh

# Switch to non-root user
USER coredns

EXPOSE 53 53/udp

ENTRYPOINT ["/entrypoint.sh"]
